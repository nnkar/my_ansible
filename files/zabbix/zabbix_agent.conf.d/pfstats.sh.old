#!/usr/bin/env bash

PFLOGSUMM="/usr/sbin/pflogsumm -d today --detail 0 /var/log/maillog"
TMPSTAT="/tmp/tmp_pfstat.dat"
TMPDAT="/tmp/pfstats.dat"
LOCK="/tmp/pfstats.lock"

usage(){
  echo "Usage: $0 <received|delivered|forwarded|deferred|bounced|rejected|held|discarded|reject_warnings|bytes_received|bytes_delivered>"
}

if [ $# -ne 1 ];then
  usage
  exit 1
fi

if [ ! -f ${LOCK} ];then
  touch ${LOCK}
  if [ -f ${TMPSTAT} ];then
    TDIFF=$((`date +"%s"` - `date -r ${TMPSTAT} +'%s'`))
  else
    TDIFF=0
  fi
  #echo ${TDIFF}
  if [ ! -f ${TMPSTAT} ] || [ $((`date +"%s"` - `date -r ${TMPSTAT} +'%s'`)) -gt 60 ];then
    ${PFLOGSUMM} | sed 's/^[ \t]*//g;s/bytes received/bytes_received/;s/bytes delivered/bytes_delivered/g' | grep "^[0-9km]\+" | grep "received\|delivered\|forwarded\|deferred\|bounced\|rejected\|held\|discarded\|reject_warnings" | tr -s " " > ${TMPSTAT}
  fi
  cp ${TMPSTAT} ${TMPDAT}
  rm -f ${LOCK}
fi

RESULT=`cat ${TMPDAT} | grep " $1" | cut -d' ' -f1 | awk '/k|m/{p = /k/?1:2}{printf "%d\n", int($1) * 1024 ^ p}'`
echo $RESULT
exit 0
#if [ "${RESULT}" == "" ];then
#  echo 0
#  exit 0
#else
#  echo ${RESULT}
#  exit 0
#fi
